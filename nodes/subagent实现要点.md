## 示意图

![image-20260126170816359](./../words/imgs/image-20260126170816359.png)

subagent用dev画出来就是一个标准的react结构的示意图

## 任务目的

该多agent架构的目的是能通过用户简单的提示词，写一篇非常详细的旅游攻略，包括具体的住宿，游玩项目，具体路线等，一应俱全。文本内容非常丰富。



## 基座模型

全程使用GLM-4.5

说明：智普官方对于普通用户在4.6和4.7模型上的并发只有1，所以这里能使用的较快效果最好的模型就是4.5，并发是10。该代码是基于asyncio的异步架构，所以对并发有一定的要求。

整个文档生成耗时普遍在5~6min。文本内容超1000字。



## 实现思想

subagents的思想就是将子agent包装成工具，从而实现上下文的隔离。子agent中的state在不进行人为操作的情况下是不进行保存的。也就是对于主agent而言，它只传递输入到子agent，然后接受子agent的输出，中间过程是不参与的。



### 架构简介

在该版本下有3个子agent

- call_around_search_agent：负责根据一个固定地点，搜索周边符合需求的其他地点（例如”成都天府三街附近的火锅店”，成都天府三街是一个地点，火锅店是关键字。关键字也可以是描述性关键字，例如好吃的，好玩的等等）
- call_path_planning_agent：负责对两个地点进行路径规划，如果这两个地点离得近，那么会推荐使用步行规划，如果离得远则优先使用驾车规划。
- call_travel_guide_agent：负责对整个旅游项目撰写一个大纲，最后的旅游规划就是基于这个大纲进行扩展的。



除此以外还有一个main_think的工具，负责在每次调用工具以后都进行深度思考，以清晰下一步的调用工具的路线。

#### call_around_search_agent

该子智能体绑定了两个工具，geocode和around_search。前者负责将自然语言的地点转化为具体的经纬度坐标（支持多个地点同时转化），后者利用经纬度坐标去检索该地点周边的场所。

`geocode`

- input：

  - address：str，require，地点1|地点2|...|地点N

  - city：str，norequire，成都

  - batch：bool，norequire，是否进行批量转化（多个地点的时候会用到）

- output：

  - 一个经过解析过滤的字典，这部分输出会被自动转化为字符串



`around_search`

- input：
  - location：str，require，"116.473168,39.993015"（只支持一个点的经纬度检索）
  - keywords：str，norequire，酒吧|KTV|洗浴中心（支持多个关键字）
  - city：str，norequire，成都
- output：
  - 一个经过解析的字符串，这部分输出会被自动转化为字符串



#### call_path_planning_agent

该子智能体绑定了四个工具

`geocode`：同上

`calculate`：输入起终点的经纬度坐标，返回两地的距离，单位：米

- input：
  - origins：List[List[float]] ，require，[[116.481028, 39.989643], [114.481028, 39.989643]]
  - destination：List[List[float]] ，require，与origins不同的是，它只能输入一组经纬度，因为它的内部并不是矩阵乘法的逻辑。
- output：
  - "10000"

`walking_route`：输入起终点的经纬度坐标，以及各自的POI（如果有的话），返回一个解析的路径字典（POI信息是高德为每一个地点定制的唯一的编号，geocode并不能获取到这一信息，也没有专门获取POI的接口，但是该信息可能会出现在其他接口的返回值里面，所以这里选择让模型动态填入会更合适）

- input：

  - origin：str，require，"116.397428,39.90923"

  - destination：str，require，格式同上

  - origin_id：str，norequire，"xxxxxx"

  - destination_id，str，norequire，"xxxxxx"

- output：
  - 解析过滤后的一个字典

`driving_route` 同上



#### call_travel_guide_agent

该子智能体会绘制一个旅游攻略的大纲，绑定了3个工具

`guiding_deepthink`：一个控制深度思考的工具，它会控制agent优化它的工具调用链路。这部分代码在langchain官方的教程([GitHub - langchain-ai/open_deep_research](https://github.com/langchain-ai/open_deep_research)) 使用过，中使用过。**本代码的提示词仅供参考**。

`district_search` 它可以返回指定行政区内指定类别下的场所（该API会返回场所的POI信息）

- input：
  - keywords：str，require，串串香|洗浴中心
  - city：str，norequire，成都武侯区
- output：
  - 一个经过解析的字典

`around_search` 与call_around_search_agent相同的工具



district_search和around_search是用来丰富内容的工具，guiding_deepthink是用来优化内容方向的工具。具体可以通过**TRAVEL_GUIDE_SYSTEM_PROMPT**来查看控制的思路。



#### main_think

这是用来控制主agent的思考工具，大致思路可以直接参考它的工具描述（仅供参考）



### 改进方向

#### rollback

该代码并没有编写严格的回退或者重试的机制，这部分主要可以通过middleware来解决。包括不同模型之间的兼容。



#### memory

该代码目前确实长期记忆的储存，这部分可以通过PGSQL来解决。同时可以有针对性的提取memory进行储存。



#### websearch

该代码没有使用任何的网络检索，只是调用了高德地图的API。本人在开发代码初期也尝试过加入网络检索的工具，但实际效果非常差。我写这个做智能体的目的就是想要实现一个非常详细的旅游攻略的。但是检索到的内容很差，我尝试使用了tavily和bocha这两款检索器，检索到的内容都很差，甚至没有资格作为大纲使用。同时小红书对个人用户开放的开发平台似乎也关闭了。同时我个人是担心最后内容的质量太过于依赖平台推送，导致结果会受到平台的影响，所以最后网络检索也没有加入到项目中。



## 结果展示

现在为您提供完整的成都自驾游攻略：

## 🚗 成都自驾游完整攻略

### 📝 行程概览

- **推荐时长**：4天3晚
- **主要区域**：成都市区 + 周边景点（青城山、都江堰）
- **适合人群**：家庭出游、朋友聚会、情侣旅行

---

## 🏨 住宿推荐

### **主要住宿区域：天府广场周边**

- **ISEYA世野·高空酒店（天府广场春熙路店）**
  - 地址：东御街18号百扬大厦37楼
  - 评分：4.9分 ⭐⭐⭐⭐⭐
  - 电话：028-83289666
  - 特色：高空景观，距天府广场地铁站仅50米

- **全季酒店（成都天府广场店）**
  - 地址：东御街55号人保大厦8层  
  - 评分：4.8分 ⭐⭐⭐⭐⭐
  - 电话：028-67255333
  - 特色：提供自助早餐，位置便利

- **成都百家民宿（西御街分店）**
  - 地址：小河街1号
  - 评分：4.8分 ⭐⭐⭐⭐⭐
  - 特色：精品民宿，距天府广场仅188米

---

## 🚗 租车信息

### **推荐租车公司**

- **一嗨租车世纪城便捷点** ⭐⭐⭐⭐⭐
  - 地址：高新区公共服务停车场地下负一层C3区
  - 电话：028-85113940 / 4008886608
  - 评分：4.6分

- **神州租车(蜀都中心店)** ⭐⭐⭐⭐⭐
  - 地址：吉瑞五路高新区公共服务停车场B1楼C5区
  - 电话：028-86040423
  - 评分：4.5分

---

## 📅 详细行程安排

### **第1天：成都历史文化深度游**

#### 🏛️ 上午（9:00-12:00）

**路线：天府广场 → 成都博物馆 → 皇城清真寺 → 东华门遗址公园**

- **成都博物馆**
  - 地址：小河街1号
  - 距天府广场约200米
  - 电话：028-68277011
  - 特色：了解成都历史文化的重要场所

- **皇城清真寺**
  - 地址：小河街2号附2号
  - 距天府广场约290米
  - 特色：历史悠久的伊斯兰宗教建筑

- **东华门遗址公园**
  - 地址：人民中路一段11号
  - 特色：历史遗址公园，文化底蕴深厚

#### 🍽️ 午餐（12:00-13:30）

**王婆婆老妈蹄花·川菜馆(春熙路店)**

- 地址：商业场街1号附41号
- 人均：63元
- 电话：19980575904
- 特色：老妈蹄花、双流老妈兔头、麻婆豆腐

#### 🏮 下午（14:00-18:00）

**路线：春熙路 → 宽窄巷子（驾车1.94公里，约8分钟）**

- **宽窄巷子**
  - 特色：成都最具代表性的历史文化街区
  - 活动：品尝小吃、购买手工艺品、体验茶文化

#### 🍽️ 晚餐（18:00-20:00）

**宽窄巷子内选择众多推荐：**

- 传统文化与现代美食结合
- 各种川菜、小吃和茶馆

#### 🏨 晚上：入住天府广场周边酒店

---

### **第2天：成都民俗美食体验日**

#### 🏛️ 上午（9:00-12:00）

**路线：天府广场 → 锦里（驾车4.2公里，约15分钟）**

- **锦里**
  - 位置：武侯区
  - 特色：古街风格，传统四川小吃集中地
  - 活动：体验传统川西文化，品尝地道四川小吃

#### 🍽️ 午餐（12:00-13:30）

**锦里内小吃推荐：**

- 三大炮、糖油果子、钟水饺、龙抄手
- 人均消费：30-50元

#### 🛍️ 下午（14:00-18:00）

**路线：锦里 → 春熙路（驾车4.2公里，约15分钟）**

- **春熙路**
  - 特色：成都最热闹的商业街区
  - 活动：购物、品尝现代美食

#### 🍽️ 晚餐（18:00-20:00）

**许家菜樽宴(大魔方店)** - 高端体验

- 地址：石羊街道天府大道北段招商大魔方中国太平金融大厦10号楼3层
- 人均：510元
- 电话：028-81266392
- 特色：精品川菜，推荐青辣汁两头黄玉参、麻辣汁东海鲜鱿

或选择**九公里鲜货火锅(春熙路店)**

- 地址：商业场街1号2层附8号
- 人均：67元
- 特色：鲜货火锅，食材新鲜

---

### **第3天：青城山道教文化之旅**

#### 🚗 上午（8:00-11:00）

**路线：成都天府广场 → 青城山（驾车65.5公里，约1小时15分钟）**

**驾车路线：**

1. 从天府广场出发，经人民南路一段、西御街
2. 经蜀都大道向西行驶约1.9公里
3. 沿清江东路经成温高架路向西行驶约4.9公里
4. 通过苏坡立交进入S8成名高速入口
5. 经文家场枢纽进入G4202成都绕城高速，向北行驶约6.4公里
6. 通过犀浦立交进入G4217蓉昌高速，向西北行驶约28.5公里
7. 从G4217蓉昌高速出口下高速
8. 沿驾青路、天府大道聚源段向西北行驶约4.8公里
9. 经聚青路向西行驶约8.7公里到达青城山

#### 🏔️ 中午（11:00-14:00）

**青城山游览**

- 前山：道教文化为主，参观古建筑群
- 后山：自然风光为主，适合徒步

#### 🍽️ 午餐（14:00-15:30）

**青城山王家大院** ⭐⭐⭐⭐⭐

- 地址：泉水二巷32号附3号
- 距离：51米
- 评分：4.5分
- 电话：028-87218189
- 特色：农家菜、地方特色

#### 🏨 下午（15:30-17:00）

**入住都江堰市区酒店**

- 距离青城山约12.5公里，驾车约20分钟

#### 🍽️ 晚餐（17:00-19:00）

**陈麻婆菜馆**

- 地址：平安园西北门东南50米
- 评分：3.7分
- 特色：川菜、麻婆豆腐等传统川菜

---

### **第4天：都江堰水利工程探索**

#### 🏞️ 上午（8:00-12:00）

**都江堰景区游览**

- **都江堰水利工程**：世界文化遗产，由鱼嘴、飞沙堰、宝瓶口三大主体工程组成
- **二王庙**：为纪念李冰父子而建
- **伏龙观**：位于离堆公园内，传说李冰治水时在此降伏孽龙
- **玉垒山公园**：可俯瞰都江堰全景

#### 🍽️ 午餐（12:00-13:30）

**欧雅名仕咖啡西餐厅(岷江店)**

- 地址：岷江路111号蓝郡新界
- 人均：74元
- 电话：028-89742292
- 评分：4.0分
- 特色：西餐、牛排、咖啡

#### 🚗 下午（14:00-16:00）

**返程：都江堰 → 成都天府广场（驾车61.7公里，约1-1.5小时）**

**返程路线：**

1. 从都江堰市区出发，沿迎宾大道进入G4217蓉昌高速
2. 沿G4217蓉昌高速向东南行驶约35公里
3. 经犀浦立交进入G4202成都绕城高速，向南行驶约6.6公里
4. 经文家场枢纽进入S8成名高速
5. 沿日月大道快速路向东行驶约5.3公里
6. 经成温高架路向东行驶约4.8公里
7. 进入市区，沿蜀都大道到达天府广场

---

## 🅿️ 停车场推荐

### **成都市中心**

1. **新世纪环球购物中心地下停车场**
   - 地址：天府大道北段1700号环球中心
   - 特色：大型购物中心配套停车场，车位充足

2. **中航城市广场地下停车场**
   - 地址：天晖南街169号中航城市广场
   - 特色：商务办公楼配套停车场

3. **地铁周边停车场**
   - 锦城大道地铁站B口停车场（距离1.2公里）
   - 交子大道地铁站C2口停车场（距离1.5公里）

---

## 💡 实用提示

### **最佳出行时间**

- **春季（3-5月）**：气候宜人，花开满城
- **秋季（9-11月）**：天高气爽，适合自驾

### **交通建议**

- 避开早晚高峰时段（7:30-9:00，17:30-19:00）
- 高速路段建议使用ETC
- 市区景点建议停车后步行游览

### **美食提示**

- 成都美食偏辣，可根据个人口味调整
- 宽窄巷子、锦里小吃价格偏高，可适量品尝
- 春熙路周边餐厅选择丰富，丰俭由人

### **费用预算（4天3晚，2人出行）**

- 住宿：600-1200元/晚 × 3晚 = 1800-3600元
- 租车：200-400元/天 × 4天 = 800-1600元
- 油费过路费：约300-500元
- 餐饮：150-300元/人/天 × 4天 × 2人 = 1200-2400元
- 门票：青城山+都江堰约200元/人
- **总计：约4300-8300元**

---

这份攻略涵盖了成都自驾游的方方面面，包括详细的路线规划、餐厅推荐、住宿安排和实用提示。您可以根据自己的喜好和时间安排进行适当调整。祝您在成都自驾游中玩得开心！🎉

